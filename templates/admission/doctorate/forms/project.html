{% extends base_template %}
{% load bootstrap3 i18n static admission enums %}

{% comment "License" %}
  * OSIS stands for Open Student Information System. It's an application
  * designed to manage the core business of higher education institutions,
  * such as universities, faculties, institutes and professional schools.
  * The core business involves the administration of students, teachers,
  * courses, programs and so on.
  *
  * Copyright (C) 2015-2023 Universit√© catholique de Louvain (http://www.uclouvain.be)
  *
  * This program is free software: you can redistribute it and/or modify
  * it under the terms of the GNU General Public License as published by
  * the Free Software Foundation, either version 3 of the License, or
  * (at your option) any later version.
  *
  * This program is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  * GNU General Public License for more details.
  *
  * A copy of this license - GNU General Public License - is available
  * at the root of the source code of this program.  If not,
  * see http://www.gnu.org/licenses/.
{% endcomment %}

{% block form %}
  {% bootstrap_form_errors form %}

  {% panel _("Course choice") %}
    <div class="row">
      <div class="col-md-12">
        {% bootstrap_field form.type_admission %}
      </div>
      <div class="col-md-12" id="justification">
        <p class="well">
          {% blocktrans trimmed %}
            Extract from the Doctoral Regulations (Article 2.1):<br />
            "Pre-admission is an optional stage of the doctoral programme. It aims to allow the candidate to complete
            the administrative and social formalities that would require a prior registration for the doctorate. [...]
            Pre-admission is valid for a maximum period of 12 months. Recourse to a pre-admission phase must be
            justified, the objectives to be achieved planned and the duration of the pre-admission period fixed in
            accordance with them. Unless exceptionally authorised by the CSD, FRIA or FNRS scholarship holders and, in
            general, doctoral candidates engaged in a research project that has already been defined, are not
            authorised to take a pre-admission phase for a doctorate."
            <br /> Please also consult the special provisions of the field for all pre-admission conditions.
          {% endblocktrans %}
        </p>
        {% bootstrap_field form.justification form_group_class="form-group required_field" %}
      </div>
    </div>
    {% if not admission %}
      <div class="row">
        <div class="col-md-6">
          {% bootstrap_field form.sector %}
        </div>
      </div>
      <div class="row" id="doctorate">
        <div class="col-md-9">
          {% bootstrap_field form.doctorate %}
        </div>
      </div>
    {% else %}
      {% field_data _("Sector") sector_label %}
      {% display admission.doctorat.intitule " (" admission.doctorat.campus ")" as doctorate_title %}
      {% field_data _("Doctorate") doctorate_title %}
      {% if admission.commission_proximite %}
        {% field_data _("Proximity commission / Subdomain") admission.commission_proximite|enum_display:'ChoixProximityCommissionCDE'|enum_display:'ChoixProximityCommissionCDSS'|enum_display:'ChoixSousDomaineSciences' %}
      {% endif %}
    {% endif %}
    <div class="row" id="commission_proximite_cde">
      <div class="col-md-6">
        {% bootstrap_field form.commission_proximite_cde %}
      </div>
    </div>
    <div class="row" id="commission_proximite_cdss">
      <div class="col-md-9">
        {% bootstrap_field form.commission_proximite_cdss %}
      </div>
    </div>
    <div class="row" id="sous_domaine">
      <div class="col-md-6">
        {% bootstrap_field form.sous_domaine %}
      </div>
    </div>
  {% endpanel %}

  {% panel _("Financing") %}
    <div class="row">
      <div class="col-md-4">
        {% bootstrap_field form.type_financement form_group_class="form-group required_field" %}
      </div>
    </div>
    <div class="row" id="work">
      {% bootstrap_field form.type_contrat_travail show_help=False form_group_class="form-group col-md-4 required_field" %}
      <div class="col-md-4">
        {% bootstrap_field form.eft form_group_class="form-group required_field" placeholder="" %}
      </div>
    </div>
    <div id="scholarship">
      <div class="row">
        {% bootstrap_field form.bourse_recherche form_group_class="form-group col-md-4 required_field" %}
        <div id="other-scholarship-container" class="col-md-4 required_field">
          {% bootstrap_field form.autre_bourse_recherche placeholder="" %}
        </div>
      </div>
      <div class="row">
        {% bootstrap_field form.bourse_date_debut form_group_class="form-group col-md-4 required_field" %}
        {% bootstrap_field form.bourse_date_fin form_group_class="form-group col-md-4 required_field" %}
      </div>
      {% bootstrap_field form.bourse_preuve form_group_class="form-group required_field" %}
    </div>
    <div id="financing-details" class="row">
      <div class="col-md-6">
        {% bootstrap_field form.duree_prevue placeholder="" form_group_class="form-group required_field" %}
      </div>
      <div class="col-md-6">
        {% bootstrap_field form.temps_consacre placeholder="" form_group_class="form-group required_field" %}
      </div>
    </div>
  {% endpanel %}

  {% panel _("Doctoral project") %}
    {% bootstrap_field form.titre_projet form_group_class="form-group required_field" placeholder="" %}
    {% bootstrap_field form.resume_projet form_group_class="form-group required_field" placeholder="" %}
    <div class="row">
      <div class="col-md-4">
        {% bootstrap_field form.langue_redaction_these form_group_class="form-group required_field" %}
      </div>
    </div>
    <div class="row">
      <div class="col-md-6">
        {% bootstrap_field_with_tooltip form.lieu_these %}
      </div>
    </div>
    <p>
      {% blocktrans trimmed %}
        The format of the documents to be uploaded below may vary from one Doctoral Domain Commission (DDC) to another.
        Please check the website of your DDC or contact your doctoral manager.
      {% endblocktrans %}
    </p>
    {% bootstrap_field form.documents_projet form_group_class="form-group required_field" %}
    {% bootstrap_field form.proposition_programme_doctoral form_group_class="form-group proposition_programme_doctoral" %}
    {% bootstrap_field_with_tooltip form.projet_formation_complementaire %}
    {% bootstrap_field form.graphe_gantt %}
    {% bootstrap_field form.lettres_recommandation %}
  {% endpanel %}

  {% panel _("Previous research experience") %}
    {% bootstrap_field_with_tooltip form.doctorat_deja_realise %}
    <div id="previous_experience">
      <div class="row">
        <div class="col-md-6">
          {% bootstrap_field form.institution placeholder="" form_group_class="form-group required_field" %}
        </div>
        <div class="col-md-6">
          {% bootstrap_field form.domaine_these placeholder="" form_group_class="form-group required_field" %}
        </div>
      </div>
      {% bootstrap_field form.non_soutenue %}
      <div class="row" id="soutenue">
        <div class="col-md-4">
          {% bootstrap_field form.date_soutenance %}
        </div>
      </div>
      <div id="non-soutenue">
        {% bootstrap_field form.raison_non_soutenue form_group_class="form-group required_field" placeholder="" %}
      </div>
    </div>
  {% endpanel %}
{% endblock %}

{% block script %}
  {{ block.super }}
  <script type="application/javascript">
  $(function () {
    const isFalsy = val => !val;

    // Justification depends on pre-admission
    $('#justification').dependsOn({
      'input[name=type_admission]': { values: ['PRE_ADMISSION'] },
    });

    {% if not admission %}
      // When a value is already set in select2, it won't be replaced by
      // ajax call, so we compare the data to evaluate if CDE is present
      {% if form.doctorate_data %}
        const initialData = {{ form.doctorate_data|safe }};
      {% else %}
        const initialData = false;
      {% endif %}

      // Install dependsOn condition after select2 has been initiliazed
      {# // TODO when using DAL 3.8.2 #}
      {# $(document).on('dal-init-function', function (e) { #}
      setTimeout(function () {

        // Reset doctorate when changing sector
        $('#id_sector').change(function () {
          $('#id_doctorate').val(null).trigger('change');
        });
        // Doctorate depends on sector
        $('#doctorate').dependsOn({
          '#id_sector': { not: [''] },
        });

        // proximity commission depends on doctorate
        $('#commission_proximite_cde').dependsOn({
          '#id_doctorate': {
            changed: function () {
              var $doctorate = $('#id_doctorate');
              if ($doctorate.hasClass('select2-hidden-accessible')) {
                var data = $doctorate.select2('data')
                if (initialData && data.length && data[0].id === initialData.id) {
                  data = [initialData];
                }
                var commissions = {{ COMMISSIONS_CDE_CLSM|safe }};
                if (data.length && commissions.includes(data[0].sigle_entite_gestion)) {
                  return true;
                }
              }
            },
          },
        }, { valueOnDisable: '' });

        $('#commission_proximite_cdss').dependsOn({
          '#id_doctorate': {
            changed: function () {
              var $doctorate = $('#id_doctorate');
              if ($doctorate.hasClass('select2-hidden-accessible')) {
                var data = $doctorate.select2('data')
                if (initialData && data.length && data[0].id === initialData.id) {
                  data = [initialData];
                }
                if (data.length && data[0].sigle_entite_gestion === '{{ COMMISSION_CDSS }}') {
                  return true;
                }
              }
            },
          },
        }, { valueOnDisable: '' });

        $('#sous_domaine').dependsOn({
          '#id_doctorate': {
            changed: function () {
              var $doctorate = $('#id_doctorate');
              if ($doctorate.hasClass('select2-hidden-accessible')) {
                var data = $doctorate.select2('data')
                if (initialData && data.length && data[0].id === initialData.id) {
                  data = [initialData];
                }
                if (data.length && data[0].sigle === '{{ SCIENCE_DOCTORATE }}') {
                  return true;
                }
              }
            },
          },
        }, { valueOnDisable: '' });

      });
    {% endif %}

    $('#work').dependsOn({
      '#id_type_financement': { values: ['WORK_CONTRACT'] },
    });
    $('#scholarship').dependsOn({
      '#id_type_financement': { values: ['SEARCH_SCHOLARSHIP'] },
    });
    $('#other-scholarship-container').dependsOn({
        "#id_bourse_recherche": { isFalsy },
    });
    $('#financing-details').dependsOn({
      '#id_type_financement': { not: [''] },
    });
    $('#previous_experience').dependsOn({
      '#id_doctorat_deja_realise': { values: ['YES', 'PARTIAL'] },
    });
    $('#non-soutenue').dependsOn({
      '#id_non_soutenue': { checked: true },
    });
    $('#soutenue').dependsOn({
      '#id_non_soutenue': { checked: false },
    });

    // Mark proposition_programme_doctoral as required depending on type
    $('.proposition_programme_doctoral').dependsOn({
      'input[name=type_admission]': { values: ['ADMISSION'] },
    }, {
      disable: false,
      hide: false,
      toggleClass: 'required_field',
    });

    document.dispatchEvent(new Event('refreshFormInitial'));
  });
  </script>
{% endblock %}
